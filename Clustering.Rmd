---
title: "Grouping Sosie based on photometric data"
author: "Ruiyang Gan"
date: "10/13/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
```

# Sosie Query
```{}
SELECT TOP 2000
   p.objid,p.ra,p.dec,p.u,p.g,p.r,p.i,p.z,
   p.cModelMag_u as c_u, p.cModelMag_g as c_g, cModelMag_r as c_r,
   p.cModelMag_i as c_i, p.cModelMag_z as c_z,
   p.deVAB_u, p.deVAB_r, p.deVAB_i, p.deVAB_z, 
   p.deVAB_g,
   p.expAB_u, p.expAB_g, p.expAB_r, p.expAB_i,
   p.expAB_z,
   s.specobjid, s.class, s.z as redshift
FROM PhotoObj AS p
   JOIN SpecObj AS s ON s.bestobjid = p.objid
WHERE 
   s.z BETWEEN 0 AND 10
   and s.class = "GALAXY"
```

```{r prelim, include=FALSE}
# Load the csv file into data and 
dat_small <- read.csv("Photo_pairs.csv", header = TRUE, skip = 1)
library(mclust)
library(dbscan)
```

# One dimensional classification of galaxies based on redshift
```{r fig.height = 8, fig.width = 14, echo=FALSE}
dat_small.redShift <- subset(dat_small, select=c("redshift"))

# Fit Gaussian Mixture model on the redshift using BIC 
# to select the optimal number of groups for gaussian mixture
BIC <- mclustBIC(dat_small.redShift)
plot(BIC)
mod1 <- Mclust(dat_small.redShift, x = BIC)
redshiftGroup <- mod1$classification
total.redShiftGroups <- length(table(redshiftGroup))
par(mfrow = c(ceiling(total.redShiftGroups/3), 3))
# Display the distribution of redshift within each group
invisible(sapply(1:length(table(redshiftGroup)), function(d) {
	  hist(dat_small$redshift[redshiftGroup == d], 
	  		 main = paste("Histogram of galaxies' redshift within group",d),
	  		 xlab = "Red shift")
	}))

# Add the redshift group label to the original data.frame
dat_small <- data.frame(dat_small, "redShiftLabel" = redshiftGroup)

```

# Finding galaxy pairs within group classified to have similar redshift 
After we obtain the preliminary grouping of galaxies based on their redshifts, we will find pairs within these groups. To accomplish the goal, we will use DBSCAN (a nearest-neghbor-searching approach) to find galaxy pairs.

```{r}
# Extract the magnitudes of color bands u,g,r,i,z we will use to classify galaxies into pairs
dat_small.cMag <- subset(dat_small, select=c("c_u","c_g","c_r","c_i","c_z"))

cMagGroup <- sapply(1:length(table(redshiftGroup)), function(d) {
	# Select the group with same redshift labelling
	dat_small.cMag.d <- dat_small.cMag[redshiftGroup == d,]
	# Normalize magnitude with respect to u's magnitude
	dat_small.cMag.d <- dat_small.cMag.d[,2:5]/dat_small.cMag.d[,1]
	
	# Scale the normalized magnitude to have unit variance
	dat_small.cMag.d <- scale(dat_small.cMag.d)
	
	# Run DBSCAN to find the sosie pairs within groups classified by the 
	# magnitude of the four color bands
	# The minPts (number of points required for a point to become a core point)
	# is set to 2 since we are looking for pairs
	# Since the color magnitude has been scaled to unit variance, therefore I will
	# use .1 as the radius
	# A better approach here would be using a hierachial model without using a fixed 
	# radius; However, for large datasets, such hierarchial model will take up large 
	# memory space and become computationally difficult. 
	rslt.d <- dbscan(dat_small.cMag.d, minPts = 2, eps = .05)
	return(rslt.d$cluster)
	})

# Attach the magnitude grouping to the original data.frame
dat_small <- data.frame(dat_small, "cMagLabel" = numeric(nrow(dat_small)))
for(d in 1:length(table(redshiftGroup))) {
	dat_small$cMagLabel[dat_small$redShiftLabel == d] <- cMagGroup[[d]]
}
```

Now that we have found the clustering based on the redshift and normalized (w.r.t magnitude of u) and magnitude, we will see if these groups have similar pattern in color magnitudes according to barplots of color magnitude
```{r fig.height = 10, fig.width = 20, echo=FALSE, dpi = 300}
# Within groups with similar redshift, we can randomly select groups with the 
# same color magnitude labeling and plot their color magnitude of u,g,r,i,z 
par(mfrow = c(ceiling(total.redShiftGroups/3), 3))
for(d in 1:length(table(redshiftGroup))){
	# Randomly select a group and plot their color magnitude side by side
	cMag.level.random <- sample(unique(cMagGroup[[d]])[-1],1)
	pairs.row <- (dat_small$redShiftLabel==d) & (dat_small$cMagLabel == cMag.level.random)
	sosie <- subset(dat_small[pairs.row,], select=c("c_u","c_g","c_r","c_i","c_z"))
	sosie <- as.matrix(sosie)
	barplot(t(sosie), beside = TRUE, 
					main = paste("Color Magnitude of randomly selected sosies with redshift labeling",d),
					xlab = "Observation", ylab = "Magnitude")
}
```


# Large data set experiment
